# Reserved Context Keys

The Keplog SDK protects certain context keys that are managed internally by the SDK. Users cannot manually set these keys.

## Protected Keys

The following keys are **reserved** and managed by the SDK:

| Key | Description | Managed By |
|-----|-------------|------------|
| `exception_class` | Exception class name | SDK (automatic) |
| `frames` | Enhanced stack frames with code snippets | SDK (automatic) |
| `queries` | Database queries | Framework/User (via `captureException`) |
| `request` | HTTP request data | User (via `captureException`) |
| `breadcrumbs` | Event breadcrumbs | SDK (automatic) |

## Why Are Keys Reserved?

Reserved keys ensure:
1. **Data integrity** - SDK-managed fields aren't overwritten accidentally
2. **Consistent structure** - Backend can validate payload structure
3. **Separation of concerns** - System context vs. user-defined context

## What Happens When You Try to Set Reserved Keys?

### Using `setContext()` Method

If you try to manually set a reserved key, the SDK will throw an `InvalidArgumentException`:

```php
$keplog = new KeplogClient(['api_key' => 'your-key']);

// ❌ This will throw an exception
try {
    $keplog->setContext('exception_class', 'MyException');
} catch (\InvalidArgumentException $e) {
    echo $e->getMessage();
    // "Cannot set reserved context key 'exception_class'.
    //  Reserved keys are: exception_class, frames, queries, request, breadcrumbs"
}

// ✅ This works fine - not a reserved key
$keplog->setContext('order_id', 123);
$keplog->setContext('payment_method', 'credit_card');
```

### Passing Context in `captureException()`

When passing context directly to `captureException()`, the SDK allows **some** reserved keys but not others:

```php
// ✅ ALLOWED - These reserved keys can be passed
$keplog->captureException($e, [
    'request' => RequestContext::capture(request()),  // ✅ Allowed
    'user' => UserContext::capture(),                 // ✅ Allowed
    'queries' => app('keplog.queries'),               // ✅ Allowed
]);

// ❌ NOT ALLOWED - These are SDK-managed only
$keplog->captureException($e, [
    'exception_class' => 'CustomException',  // ❌ Throws exception
    'frames' => [],                          // ❌ Throws exception
    'breadcrumbs' => [],                     // ❌ Throws exception
]);
```

## Allowed vs. Forbidden Reserved Keys

### Allowed in `captureException()`:
- `request` - You provide HTTP request data
- `user` - You provide user authentication data
- `queries` - You provide database query logs

These are **input data** that you control and pass to the SDK.

### Forbidden Everywhere:
- `exception_class` - SDK extracts from the exception automatically
- `frames` - SDK generates enhanced stack frames automatically
- `breadcrumbs` - SDK manages via `addBreadcrumb()` method

These are **output data** generated by the SDK.

## Best Practices

### ✅ DO: Use User-Defined Context

**Standalone/Plain PHP:**

```php
// Set custom context (goes to extra_context)
$keplog->setContext('environment_type', 'staging');
$keplog->setContext('feature_flags', ['new_checkout' => true]);

// Pass framework-specific data
$keplog->captureException($e, [
    'request' => RequestContext::capture(request()),
    'user' => UserContext::capture(),
    'queries' => $queries,

    // Custom fields
    'order_id' => $orderId,
    'cart_total' => $cartTotal,
]);
```

**Laravel 12+ (bootstrap/app.php):**

```php
// In bootstrap/app.php
->withExceptions(function (Exceptions $exceptions): void {
    $exceptions->report(function (Throwable $e) {
        if (app()->bound('keplog')) {
            app('keplog')->captureException($e, [
                // SDK-managed (goes to context)
                'request' => RequestContext::capture(request()),
                'user' => UserContext::capture(),
                'queries' => app('keplog.queries') ?? [],

                // User-defined (goes to extra_context)
                'order_id' => session('order_id'),
                'cart_total' => session('cart_total'),
                'feature_flags' => config('features'),
            ]);
        }
    });
})
```

### ❌ DON'T: Try to Override SDK Fields

```php
// DON'T do this - will throw exception
$keplog->setContext('exception_class', 'MyException');
$keplog->setContext('frames', []);

// DON'T do this - will throw exception
$keplog->captureException($e, [
    'breadcrumbs' => [['message' => 'custom']],
]);
```

### ✅ DO: Use SDK Methods

```php
// Use addBreadcrumb() instead of setting breadcrumbs manually
$keplog->addBreadcrumb([
    'category' => 'navigation',
    'message' => 'User clicked checkout button',
    'level' => 'info',
]);

// Exception class is automatically extracted
// Frames are automatically generated
// No need to set these manually!
```

## Checking Reserved Keys

You can get the list of reserved keys programmatically:

```php
use Keplog\Scope;

$reservedKeys = Scope::getReservedKeys();
// Returns: ['exception_class', 'frames', 'queries', 'request', 'breadcrumbs']

// Check if a key is reserved
if (in_array($myKey, $reservedKeys)) {
    echo "This key is reserved!";
}
```

## Error Messages

### When using `setContext()`:

```
InvalidArgumentException: Cannot set reserved context key 'frames'.
Reserved keys are: exception_class, frames, queries, request, breadcrumbs
```

### When passing to `captureException()`:

```
InvalidArgumentException: Cannot set reserved context key 'exception_class'.
Use SDK methods to set this field.
```

## Summary

- **Reserved keys protect SDK-managed data**
- **You can pass `request`, `user`, `queries` in `captureException()`**
- **You cannot manually set `exception_class`, `frames`, `breadcrumbs`**
- **All your custom data goes to `extra_context` automatically**
- **Attempting to set reserved keys throws `InvalidArgumentException`**

This design ensures clean separation between SDK-managed system context and user-defined extra context.
